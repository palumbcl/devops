name: CI devops 2025
on:
  #to begin you want to launch this job in main
  push:
    branches: [main, develop]
  pull_request:

jobs:
  test-backend:
    runs-on: ubuntu-22.04
    steps:
      #checkout your github code using actions/checkout@v4
      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      #do the same with another action (actions/setup-java@4) that enable to setup jdk 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: "corretto"
          java-version: "21"

      #finally build your app with the latest command
      - name: Build and test with Maven
        run: mvn clean verify
        working-directory: tp-devops-correction-docker-main/simple-api

    # define job to build and publish docker image

  build-and-push-docker-image:
  needs: test-backend
  # run only when code is compiling and tests are passing
  runs-on: ubuntu-22.04

  # steps to perform in job
  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to Docker Hub # Log in to Docker Hub using credentials stored in secrets
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }} # Docker Hub username from secrets
        password: ${{ secrets.DOCKERHUB_TOKEN }} # Docker Hub token from secrets

    # Build and push the backend Docker image
    - name: Build and push backend image
      uses: docker/build-push-action@v3
      with:
        context: ./tp-devops-correction-docker-main/simple-api # Directory containing the backend code
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/tp-devops-backend:latest # Docker image tag
        push: ${{ github.ref == 'refs/heads/main' }} # Push image only if commit is on the 'main' branch

    # Build and push the database Docker image
    - name: Build and push database image
      uses: docker/build-push-action@v3
      with:
        context: ./tp-devops-correction-docker-main/database # Directory containing the database code
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/tp-devops-db:latest # Docker image tag
        push: ${{ github.ref == 'refs/heads/main' }} # Push image only if commit is on the 'main' branch

    # Build and push the HTTP Docker image
    - name: Build and push httpd image
      uses: docker/build-push-action@v3
      with:
        context: ./tp-devops-correction-docker-main/http-server # Directory containing the HTTP service code
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/tp-devops-http:latest # Docker image tag
        push: ${{ github.ref == 'refs/heads/main' }} # Push image only if commit is on the 'main' branch

